{"version":3,"file":"my-lib.js","sources":["../src/constants.ts","../src/prototypes/Creep.ts","../src/globals.ts","../src/manageCreeps.ts","../src/tasks/utils.ts","../src/tasks/deposit.task.ts","../src/tasks/source.task.ts","../src/index.ts"],"sourcesContent":["\nexport const PATH_STYLE: PolyStyle = {\n    fill: \"transparent\",\n    opacity: 0.1,\n    stroke: \"#febf2b\",\n    strokeWidth: 0.2,\n    lineStyle: \"dashed\"\n}\n\n\nexport const DEFAULT_MOVE_OPTS: MoveToOpts = {\n    reusePath: 20,\n    visualizePathStyle: PATH_STYLE\n}","import { DEFAULT_MOVE_OPTS } from \"../constants\"\n\nCreep.prototype.speak = function(this: Creep, ...args: Parameters<typeof console.log>) {\n    console.log(this.name, ...args)\n}\n\n// @ts-expect-error overloads are dumb\nCreep.prototype.goto = function(this: Creep, target: Parameters<Creep[\"moveTo\"]>[0] | number, opts?: MoveToOpts | number): ReturnType<Creep[\"moveTo\"]> {\n    if (typeof target === \"number\" || typeof opts === \"number\") return ERR_INVALID_TARGET;\n    const r = this.moveTo(target, Object.assign({}, DEFAULT_MOVE_OPTS, opts))\n\n    // They might be blocked on their \"remembered\" path; we should tone that way down to try and get them unstuck\n    if (r !== OK) return this.moveTo(target, Object.assign({}, DEFAULT_MOVE_OPTS, opts, { reusePath: 2 }))\n    return r\n}","export const creeps: Record<Room[\"name\"], Creep[]> = {}","import { creeps } from \"./globals\";\n\nexport const manageCreeps = () => {\n  if (Game.time % 100 === 0) {\n    // Cleanup Memory\n    for (const name in Memory.creeps) {\n      if (!(name in Game.creeps)) {\n        // eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n        delete Memory.creeps[name];\n      }\n    }\n  }\n\n  for (const name in Game.creeps) {\n    const creep = Game.creeps[name];\n    if (!creep.my) {\n      continue;\n    }\n    const room = creep.memory.room || creep.room.name;\n    creeps[room] = creeps[room] || [];\n    creeps[room].push(creep);\n  }\n};\n\nexport const spawn = (r: Room | Room[\"name\"]) => {\n  if (typeof r === \"string\") r = Game.rooms[r];\n\n  const roomCreeps = creeps[r.name] ?? [];\n  let body: BodyPartConstant[] = [];\n  let role: string = \"\";\n  if (roomCreeps.length < 3) {\n    // Short on hands, spawn some basic boys\n    if (r.energyAvailable >= 250) {\n      body = [\"work\", \"carry\", \"move\", \"move\"];\n      role = \"basic-worker\";\n    }\n  } else {\n    /*\n      BODYPART_COST: {\n        \"move\": 50,\n        \"work\": 100,\n        \"attack\": 80,\n        \"carry\": 50,\n        \"heal\": 250,\n        \"ranged_attack\": 150,\n        \"tough\": 10,\n        \"claim\": 600\n    },\n    */\n    switch (true) {\n      case r.energyAvailable >= 500:\n        body = [\"work\", \"work\", \"carry\", \"carry\", \"move\", \"move\", \"move\", \"move\"]\n        role = \"mid-worker\"\n        break;\n    }\n  }\n\n  if (body.length) {\n    // find a spawn\n    const spawns = r.find(FIND_MY_SPAWNS, {\n      filter: (s) => !Boolean(s.spawning),\n    });\n    if (spawns.length) {\n      const spawnStatus = spawns\n        .pop()\n        ?.spawnCreep(\n          body,\n          [r.name, Game.time, role].filter(Boolean).join(\":\"),\n          {\n            memory: {\n              room: r.name,\n              role: role,\n            },\n          }\n        );\n        if (spawnStatus === OK) {\n          console.log(\"Spawned a screep!\")\n        } else {\n          console.log(\"Failed to spawn a screep!\", spawnStatus)\n        }\n    }\n  }\n};\n","export const finishTask = (creep: Creep, nextId?: CreepMemory[\"task\"]) => {\n  creep.speak(\"Work Complete\");\n  if (creep.memory.task && creep.memory.task in creep.room.memory.tasks) {\n    console.log(\n      creep.room.memory.tasks[creep.memory.task],\n      Object.keys(creep.room.memory.tasks),\n      creep.memory.task\n    );\n    const creepTaskIdx = creep.room.memory.tasks[creep.memory.task]?.indexOf(\n      creep.name\n    );\n    creep.room.memory.tasks[creep.memory.task][creepTaskIdx] = null;\n    // TODO: When should the task be removed from the room\n  }\n\n  creep.memory.task = nextId;\n};\n\nexport const findTask = (creep: Creep) => {\n  // TODO: Future check that creep has correct body parts\n\n  \n  const task = Object.entries(creep.room.memory.tasks).reduce((a, [targetId, assignees]) => {\n    if (assignees.indexOf(null) === -1) return a;\n    const target = Game.getObjectById(targetId as TaskId)\n    if (!target) return a;\n    const pf = PathFinder.search(creep.pos, target.pos)  \n    if (pf.cost < a.distance) {\n        return { targetId, distance: pf.cost }\n    } else {\n        return a;\n    }\n  }, { targetId: null, distance: Number.MAX_SAFE_INTEGER })\n\n\n  if (!task.targetId) {\n    creep.speak(\"Bored\");\n    return;\n  }\n\n  // Replace first null with this creep\n  const idx = creep.room.memory.tasks[task.targetId].indexOf(null)\n  creep.room.memory.tasks[task.targetId][idx] = creep.name;\n  creep.memory.task = task.targetId as TaskId;\n};\n","import { DEFAULT_MOVE_OPTS } from \"../constants\";\nimport { finishTask } from \"./utils\";\n\nexport const depositTask = (creep: Creep, target: StructureStorage | StructureController) => {\n    \n    const r = creep.transfer(\n        target,\n        RESOURCE_ENERGY,\n        creep.store.getUsedCapacity()\n    )\n    switch (r) {\n        case ERR_NOT_IN_RANGE:\n            creep.goto(target);\n            break;\n        case OK:\n        case ERR_NOT_ENOUGH_ENERGY:\n            creep.speak(`Depositing (${creep.store.getUsedCapacity()} / ${creep.store.getCapacity()})`)\n            if (creep.store.getUsedCapacity() === 0) {\n                // All done\n                finishTask(creep)\n            }\n            break;\n        default:\n            creep.speak(\"Unhandled deposit status\", r)\n    }\n}","import { DEFAULT_MOVE_OPTS } from \"../constants\";\nimport { finishTask } from \"./utils\";\n\nexport const sourceTask = (creep: Creep, target: Source) => {\n  const r = creep.harvest(target);\n  switch (r) {\n    case ERR_NOT_IN_RANGE:\n      creep.goto(target);\n      break;\n    case OK:\n      // No free space; full\n      if (creep.store.getFreeCapacity() === 0) {\n        // Creep is full\n        if (!creep.room.controller)\n          throw new Error(\"Creep is full in a room without a controller\");\n\n        const spawns = creep.room.find(FIND_MY_SPAWNS, {\n          filter: (s) => s.store.getFreeCapacity(RESOURCE_ENERGY) > 0,\n        });\n        if (spawns.length) {\n          finishTask(creep, spawns[0].id);\n        } else {\n          finishTask(creep, creep.room.controller.id);\n        }\n      }\n      break;\n    default:\n      creep.speak(\"Unhandled mining case\", r);\n      break;\n  }\n};\n","import \"./prototypes/Creep\"\n\nimport { creeps } from \"./globals\";\nimport { manageCreeps, spawn } from \"./manageCreeps\";\nimport { depositTask } from \"./tasks/deposit.task\";\nimport { sourceTask } from \"./tasks/source.task\";\nimport { findTask } from \"./tasks/utils\";\nexport const loop = () => {\n  manageCreeps();\n  for (const roomName in Game.rooms) {\n    const room = Game.rooms[roomName];\n\n    if (!room.memory.tasks) room.memory.tasks = {};\n    // Do all room-specific logicing here\n    spawn(room);\n\n    const roomCreeps = creeps[roomName] ?? [];\n\n    for (const creep of roomCreeps) {\n      if (!creep.memory.task) findTask(creep);\n      if (creep.memory.task) {\n        const target = Game.getObjectById(creep.memory.task);\n        if (target instanceof Source) {\n          creep.speak(\"Mining\");\n          sourceTask(creep, target);\n        } else if (\n          target instanceof StructureStorage ||\n          target instanceof StructureController\n        ) {\n          creep.speak(\"Depositing\");\n          depositTask(creep, target);\n        } else {\n          creep.speak(\"Broken\", target);\n        }\n      }\n    }\n\n    for (const source of room.find(FIND_SOURCES_ACTIVE)) {\n      if (!room.memory.tasks[source.id]) {\n        room.memory.tasks[source.id] = [null, null, null]; // 3 per source\n      }\n    }\n  }\n};\n"],"names":["PATH_STYLE","DEFAULT_MOVE_OPTS","args","target","opts","r","creeps","manageCreeps","name","creep","room","spawn","roomCreeps","_a","body","role","spawns","s","spawnStatus","_b","finishTask","nextId","creepTaskIdx","findTask","task","a","targetId","assignees","pf","idx","depositTask","sourceTask","loop","roomName","source"],"mappings":"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"}